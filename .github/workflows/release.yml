name: Build & Release

on:
  push:
    tags: [ 'v*' ]
  workflow_dispatch:

permissions:
  contents: write

env:
  JAVA_VERSION: '21'
  APP_NAME: 'Tilitin'
  APP_VENDOR: 'Priku'
  APP_DESCRIPTION: 'Ilmainen suomalainen kirjanpito-ohjelma'

jobs:
  # =============================================================================
  # Job 1: Build JAR and create GitHub Release
  # =============================================================================
  build-and-release:
    name: Build JAR & Create Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven

    - name: Build with Maven
      run: mvn -B clean package --file pom.xml

    - name: Verify build
      run: |
        echo "‚úÖ Build successful"
        ls -lh target/tilitin*.jar

    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: tilitin-jar
        path: target/tilitin*.jar
        retention-days: 90

    - name: Extract version from tag
      id: version
      run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

    - name: Extract release notes from CHANGELOG
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"
        echo "Extracting release notes for version $VERSION from CHANGELOG.md..."
        
        awk -v ver="$VERSION" '
          /^## \[/ { 
            if (found) exit
            if (index($0, "[" ver "]") > 0) found=1 
          }
          found && /^---$/ { exit }
          found { print }
        ' CHANGELOG.md > release-notes.md
        
        if [ -s release-notes.md ]; then
          echo "‚úÖ Found release notes for v$VERSION ($(wc -l < release-notes.md) lines)"
        else
          echo "‚ö†Ô∏è No specific notes found, using default"
          cat > release-notes.md << EOF
        ## Tilitin v$VERSION
        
        ### Lataukset
        
        | K√§ytt√∂j√§rjestelm√§ | Tiedosto |
        |-------------------|----------|
        | ü™ü Windows | \`Tilitin-$VERSION-Setup.exe\` |
        | üçé macOS (M1/M2/M3) | \`Tilitin-$VERSION-arm64.dmg\` |
        | üçé macOS (Intel) | \`Tilitin-$VERSION.dmg\` |
        | üêß Linux (Debian/Ubuntu) | \`tilitin_$VERSION-1_amd64.deb\` |
        | üêß Linux (Red Hat/Fedora) | \`tilitin-$VERSION-1.x86_64.rpm\` |
        | ‚òï Cross-platform JAR | \`tilitin-$VERSION-priku.1.jar\` |
        
        **macOS-k√§ytt√§jille:** Lataa oikea versio prosessorillesi. Jos DMG ei toimi, k√§yt√§ JAR-versiota.
        
        Katso t√§ysi muutosloki: [CHANGELOG.md](https://github.com/priku/tilitin/blob/master/CHANGELOG.md)
        EOF
        fi

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        name: Tilitin ${{ github.ref_name }}
        draft: false
        body_path: release-notes.md
        files: |
          target/tilitin*.jar

  # =============================================================================
  # Job 2: Linux packages (.deb, .rpm)
  # =============================================================================
  linux-packages:
    name: üêß Linux Packages
    runs-on: ubuntu-latest
    needs: build-and-release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download JAR artifact
      uses: actions/download-artifact@v4
      with:
        name: tilitin-jar
        path: target/

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Install packaging tools
      run: sudo apt-get update && sudo apt-get install -y fakeroot rpm

    - name: Get JAR filename
      id: jar
      run: |
        JAR_FILE=$(ls target/tilitin*.jar | head -1)
        echo "JAR_FILE=$JAR_FILE" >> $GITHUB_OUTPUT
        echo "Found JAR: $JAR_FILE"

    - name: Build Linux DEB package
      run: |
        VERSION="${{ needs.build-and-release.outputs.version }}"
        jpackage \
          --input target \
          --main-jar $(basename ${{ steps.jar.outputs.JAR_FILE }}) \
          --name tilitin \
          --app-version "$VERSION" \
          --vendor "${{ env.APP_VENDOR }}" \
          --description "${{ env.APP_DESCRIPTION }}" \
          --type deb \
          --linux-shortcut \
          --linux-menu-group "Office;Finance" \
          --dest dist/
        echo "‚úÖ DEB package created"
        ls -lh dist/*.deb

    - name: Build Linux RPM package
      run: |
        VERSION="${{ needs.build-and-release.outputs.version }}"
        jpackage \
          --input target \
          --main-jar $(basename ${{ steps.jar.outputs.JAR_FILE }}) \
          --name tilitin \
          --app-version "$VERSION" \
          --vendor "${{ env.APP_VENDOR }}" \
          --description "${{ env.APP_DESCRIPTION }}" \
          --type rpm \
          --linux-shortcut \
          --linux-menu-group "Office;Finance" \
          --dest dist/
        echo "‚úÖ RPM package created"
        ls -lh dist/*.rpm

    - name: Upload Linux packages to release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        files: |
          dist/*.deb
          dist/*.rpm

  # =============================================================================
  # Job 3: Windows installer (.exe)
  # =============================================================================
  windows-installer:
    name: ü™ü Windows Installer
    runs-on: windows-latest
    needs: build-and-release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download JAR artifact
      uses: actions/download-artifact@v4
      with:
        name: tilitin-jar
        path: target/

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Build Windows app-image with jPackage
      run: |
        $VERSION = "${{ needs.build-and-release.outputs.version }}"
        $JAR_FILE = Get-ChildItem -Path target -Filter "tilitin*.jar" | Select-Object -First 1
        
        Write-Host "Building Windows app-image for version $VERSION"
        Write-Host "Using JAR: $($JAR_FILE.Name)"
        
        jpackage `
          --input target `
          --main-jar $JAR_FILE.Name `
          --name Tilitin `
          --app-version $VERSION `
          --vendor "${{ env.APP_VENDOR }}" `
          --description "${{ env.APP_DESCRIPTION }}" `
          --type app-image `
          --win-console `
          --dest dist
        
        Write-Host "‚úÖ Windows app-image created"
        Get-ChildItem -Path dist -Recurse | Select-Object FullName
      shell: pwsh

    - name: Install Inno Setup
      run: choco install innosetup -y

    - name: Build Inno Setup installer
      run: |
        echo "Building Inno Setup installer..."
        .\build-inno-installer.bat
      shell: cmd

    - name: Upload Windows installer to release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        files: |
          dist/installer/*.exe

  # =============================================================================
  # Job 4: macOS packages (.dmg) - Intel and ARM
  # =============================================================================
  macos-package:
    name: üçé macOS Package
    runs-on: ${{ matrix.runner }}
    needs: build-and-release
    strategy:
      matrix:
        include:
          - runner: macos-13  # Intel x86_64
            arch: x64
            suffix: intel
          - runner: macos-14  # Apple Silicon ARM64
            arch: aarch64
            suffix: arm64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download JAR artifact
      uses: actions/download-artifact@v4
      with:
        name: tilitin-jar
        path: target/

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Build macOS DMG package
      run: |
        VERSION="${{ needs.build-and-release.outputs.version }}"
        JAR_FILE=$(ls target/tilitin*.jar | head -1)
        
        echo "Building macOS DMG for version $VERSION (${{ matrix.arch }})"
        echo "Using JAR: $JAR_FILE"
        echo "Runner: ${{ matrix.runner }}"
        
        jpackage \
          --input target \
          --main-jar $(basename "$JAR_FILE") \
          --name Tilitin \
          --app-version "$VERSION" \
          --vendor "${{ env.APP_VENDOR }}" \
          --description "${{ env.APP_DESCRIPTION }}" \
          --type dmg \
          --mac-package-name "Tilitin" \
          --java-options "-Dapple.laf.useScreenMenuBar=true" \
          --java-options "-Dapple.awt.application.name=Tilitin" \
          --java-options "-Xdock:name=Tilitin" \
          --dest dist/
        
        # Rename DMG to include architecture
        DMG_FILE=$(ls dist/*.dmg)
        DMG_BASENAME=$(basename "$DMG_FILE" .dmg)
        if [ "${{ matrix.suffix }}" != "intel" ]; then
          mv "$DMG_FILE" "dist/${DMG_BASENAME}-${{ matrix.suffix }}.dmg"
        fi
        
        echo "‚úÖ macOS DMG created for ${{ matrix.arch }}"
        ls -lh dist/*.dmg

    - name: Upload macOS package to release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        files: |
          dist/*.dmg

  # =============================================================================
  # Job 5: Package dependencies (GPL compliance)
  # =============================================================================
  package-dependencies:
    name: üì¶ Package Dependencies
    runs-on: ubuntu-latest
    needs: build-and-release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven

    - name: Gather dependencies with sources
      run: mvn -B dependency:copy-dependencies -Dclassifier=sources

    - name: Zip dependencies
      run: cd target && zip -9 -r tilitin-dependencies.zip dependency

    - name: Upload dependencies to release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        files: target/tilitin-dependencies.zip
